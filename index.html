<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taxi Meter Pro - è¨ˆç¨‹è»Šè·³è¡¨æ¨¡æ“¬å™¨</title>
    
    <!-- Tailwind CSS (Via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* å…¨åŸŸè¨­å®š */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F7FA;
            color: #2D3748;
            overflow: hidden; /* é˜²æ­¢æ•´å€‹é é¢æ²å‹• */
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
        }

        /* æ•¸ä½å­—é«” */
        .font-digital {
            font-family: 'Orbitron', monospace;
        }

        /* è‡ªè¨‚æ²è»¸ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #EDF2F7;
        }
        ::-webkit-scrollbar-thumb {
            background: #CBD5E0;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #A0AEC0;
        }

        /* Leaflet å±¤ç´šä¿®æ­£ */
        .leaflet-container {
            z-index: 0;
            background: #F5F7FA;
        }

        /* iOS Safe Area */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* å·¥å…·é¡ï¼šéš±è—å…ƒç´  */
        .hidden-el {
            display: none !important;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- 1. é ‚éƒ¨å°èˆªåˆ— -->
    <header class="shrink-0 relative z-20 px-4 py-3 border-b border-gray-200 bg-white/90 backdrop-blur-md flex justify-between items-center gap-2 shadow-sm">
        <div class="flex items-center gap-3 min-w-0">
            <div class="bg-yellow-400 text-gray-900 font-bold px-2 py-1 rounded text-xs font-digital tracking-widest shadow-sm hidden sm:block border border-yellow-500/20">
                TAXI
            </div>
            <h1 class="font-bold tracking-tight text-lg sm:text-xl whitespace-nowrap text-gray-800">
                è·³è¡¨<span class="text-blue-600">æ¨¡æ“¬å™¨</span>
            </h1>
            
            <!-- æ¨¡å¼æ¨™ç±¤ (JSæ§åˆ¶é¡¯ç¤º) -->
            <span id="badge-sim" class="hidden-el text-[10px] bg-purple-50 text-purple-600 px-2 py-0.5 rounded-full border border-purple-200 flex items-center gap-1 whitespace-nowrap font-medium">
                æ¨¡æ“¬æ¨¡å¼
            </span>
            <span id="badge-gps" class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full border border-blue-200 flex items-center gap-1 whitespace-nowrap font-medium">
                GPS æ¨¡å¼
            </span>
        </div>

        <div class="flex gap-2 items-center">
            <!-- ç¸£å¸‚é¸æ“‡ -->
            <select id="select-city" class="bg-white border border-gray-300 text-gray-700 text-xs sm:text-sm rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none max-w-[120px] shadow-sm transition-all hover:border-gray-400">
                <option value="NORTH_CENTRAL">åŒ—åŒ—åŸº / å°ä¸­</option>
                <option value="TAOYUAN">æ¡ƒåœ’</option>
                <option value="HSINCHU_MIAOLI">æ–°ç«¹ / è‹—æ —</option>
                <option value="CHIAYI">å˜‰ç¾©</option>
                <option value="SOUTH">å°å— / é«˜é›„</option>
            </select>

            <!-- å¤œé–“åŠ æˆæŒ‰éˆ• -->
            <button id="btn-night" class="h-[32px] px-3 rounded-lg border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 flex items-center gap-1.5 transition-all shadow-sm font-medium text-xs">
                <span>ğŸŒ™</span>
                <span class="hidden xs:inline">å¤œé–“</span>
            </button>
        </div>
    </header>

    <!-- 2. ä¸»å…§å®¹å€ (å·¦å³åˆ†å‰²) -->
    <div class="flex-1 relative flex flex-col lg:flex-row overflow-hidden">
        
        <!-- å·¦å´/ä¸Šæ–¹ï¼šåœ°åœ– -->
        <div class="basis-[45%] lg:basis-[55%] relative border-b lg:border-b-0 lg:border-r border-gray-200 bg-gray-100">
            <div id="map" class="w-full h-full"></div>
            <!-- éŒ¯èª¤è¨Šæ¯æç¤º -->
            <div id="error-msg" class="hidden-el absolute top-4 left-4 right-4 bg-red-50 text-red-700 px-3 py-2 rounded-lg border border-red-200 shadow-lg text-sm flex items-center gap-2 z-[1000]">
                âš ï¸ <span id="error-text">GPS Error</span>
            </div>
        </div>

        <!-- å³å´/ä¸‹æ–¹ï¼šå„€è¡¨æ¿ -->
        <div class="basis-[55%] lg:basis-[45%] flex flex-col bg-[#F5F7FA] relative overflow-y-auto pb-safe">
            
            <!-- æ•¸æ“šé¡¯ç¤ºå€ -->
            <div class="flex-1 p-5 flex flex-col gap-5 pb-28">
                
                <!-- ç¸½è»Šè³‡å¡ç‰‡ -->
                <div class="flex flex-col items-center justify-center p-4 bg-white rounded-2xl border border-orange-100 shadow-lg ring-1 ring-orange-50 transition-all">
                    <span class="text-gray-500 text-xs md:text-sm uppercase tracking-wider font-semibold mb-1">
                        ç›®å‰è»Šè³‡ (NTD)
                    </span>
                    <div class="flex items-baseline gap-2">
                        <span id="val-fare" class="font-digital font-bold tabular-nums tracking-wide text-6xl md:text-7xl text-orange-600">
                            85
                        </span>
                    </div>
                </div>

                <!-- æ¬¡è¦æ•¸æ“šç¶²æ ¼ -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- è·é›¢ -->
                    <div class="flex flex-col items-center justify-center p-4 bg-white rounded-2xl border border-gray-200 shadow-sm">
                        <span class="text-gray-500 text-xs uppercase font-semibold mb-1">è¡Œé§›è·é›¢</span>
                        <div class="flex items-baseline gap-1">
                            <span id="val-dist" class="font-digital font-bold text-2xl md:text-3xl text-blue-700">0.00</span>
                            <span class="text-gray-400 text-sm">km</span>
                        </div>
                    </div>
                    <!-- é€Ÿåº¦ -->
                    <div class="flex flex-col items-center justify-center p-4 bg-white rounded-2xl border border-gray-200 shadow-sm">
                        <span class="text-gray-500 text-xs uppercase font-semibold mb-1">ç§»å‹•é€Ÿåº¦</span>
                        <div class="flex items-baseline gap-1">
                            <span id="val-speed" class="font-digital font-bold text-2xl md:text-3xl text-emerald-700">0.0</span>
                            <span class="text-gray-400 text-sm">km/h</span>
                        </div>
                    </div>
                    <!-- å»¶æ»¯æ™‚é–“ -->
                    <div class="flex flex-col items-center justify-center p-4 bg-white rounded-2xl border border-gray-200 shadow-sm">
                        <span class="text-gray-500 text-xs uppercase font-semibold mb-1">åœç­‰æ™‚é–“ (å»¶æ»¯)</span>
                        <span id="val-idle" class="font-digital font-bold text-xl md:text-2xl text-gray-700">00:00</span>
                    </div>
                    <!-- ç¸½æ™‚é–“ -->
                    <div class="flex flex-col items-center justify-center p-4 bg-white rounded-2xl border border-gray-200 shadow-sm">
                        <span class="text-gray-500 text-xs uppercase font-semibold mb-1">è¡Œé§›æ™‚é–“</span>
                        <span id="val-time" class="font-digital font-bold text-xl md:text-2xl text-blue-700">00:00</span>
                    </div>
                </div>

                <!-- è²»ç‡è³‡è¨Š -->
                <div class="mt-auto p-4 rounded-xl border border-gray-200 bg-white text-xs text-gray-600 shadow-sm space-y-2">
                    <div class="flex items-center gap-2 mb-1 text-gray-800 font-bold border-b border-gray-100 pb-2 text-sm">
                        <div class="bg-blue-100 p-1 rounded-md text-blue-600">â„¹ï¸</div>
                        <span id="info-city-name">åŒ—åŒ—åŸº / å°ä¸­ è¨ˆè²»è¦å‰‡</span>
                    </div>
                    <div class="grid gap-1 pl-1">
                        <p>â€¢ èµ·è·³åƒ¹: <span id="info-base" class="font-semibold text-gray-900">$85</span></p>
                        <p>â€¢ çºŒç¨‹è²»: <span id="info-dist" class="font-semibold text-gray-900">$5</span> / <span id="info-dist-step">200</span>m</p>
                        <p>â€¢ å»¶æ»¯è²»: <span id="info-idle" class="font-semibold text-gray-900">$5</span> / <span id="info-idle-step">60</span>s (æ™‚é€Ÿ &lt; 5km/h)</p>
                        <p id="info-night-msg" class="hidden-el text-indigo-600 font-medium mt-1 bg-indigo-50 p-1.5 rounded-lg border border-indigo-100">
                            ğŸŒ™ å¤œé–“åŠ æˆå·²å•Ÿç”¨ (<span id="info-night-val">+$20</span>)
                        </p>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨æ§åˆ¶åˆ— -->
            <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t border-gray-200 pb-safe z-50 lg:absolute">
                <div class="max-w-3xl mx-auto flex gap-3 items-center justify-center">
                    
                    <!-- æ¨¡æ“¬æŒ‰éˆ• -->
                    <button id="btn-sim" class="flex flex-col items-center justify-center w-20 h-16 rounded-xl transition-all active:scale-95 shadow-sm border bg-white border-gray-200 text-gray-500 hover:bg-gray-50">
                        <span class="text-xl mb-1">ğŸš—</span>
                        <span class="text-[11px] font-bold">æ¨¡æ“¬</span>
                    </button>

                    <!-- é–‹å§‹/åœæ­¢æŒ‰éˆ• -->
                    <button id="btn-main" class="flex-1 h-16 bg-emerald-500 hover:bg-emerald-600 active:bg-emerald-700 text-white rounded-xl font-bold text-xl tracking-wide flex items-center justify-center gap-2 shadow-lg shadow-emerald-200 transition-all active:scale-95">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        é–‹å§‹è¨ˆè²»
                    </button>

                    <!-- é‡ç½®æŒ‰éˆ• -->
                    <button id="btn-reset" class="w-20 h-16 rounded-xl flex flex-col items-center justify-center border border-gray-200 bg-white text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-all active:scale-95 shadow-sm">
                        <span class="text-xl mb-1">â†º</span>
                        <span class="text-[11px] font-bold">é‡ç½®</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é‚è¼¯è…³æœ¬ -->
    <script>
        // --- 1. é…ç½®èˆ‡å¸¸æ•¸ ---
        const RATE_CONFIG = {
            'NORTH_CENTRAL': {
                name: 'åŒ—åŒ—åŸº / å°ä¸­',
                baseFare: 85,
                baseDistance: 1250,
                distStep: 200,
                distPrice: 5,
                idleSpeedThreshold: 5,
                idleStep: 60,
                idlePrice: 5,
                nightSurchargeType: 'FLAT', // FLAT or PERCENTAGE
                nightSurchargeValue: 20
            },
            'TAOYUAN': {
                name: 'æ¡ƒåœ’',
                baseFare: 90,
                baseDistance: 1250,
                distStep: 200,
                distPrice: 5,
                idleSpeedThreshold: 5,
                idleStep: 80,
                idlePrice: 5,
                nightSurchargeType: 'NONE',
                nightSurchargeValue: 0
            },
            'HSINCHU_MIAOLI': {
                name: 'æ–°ç«¹ / è‹—æ —',
                baseFare: 100,
                baseDistance: 1250,
                distStep: 200,
                distPrice: 5,
                idleSpeedThreshold: 5,
                idleStep: 80,
                idlePrice: 5,
                nightSurchargeType: 'NONE',
                nightSurchargeValue: 0
            },
            'CHIAYI': {
                name: 'å˜‰ç¾©',
                baseFare: 100,
                baseDistance: 1250,
                distStep: 220,
                distPrice: 5,
                idleSpeedThreshold: 5,
                idleStep: 100,
                idlePrice: 5,
                nightSurchargeType: 'FLAT',
                nightSurchargeValue: 20
            },
            'SOUTH': {
                name: 'å°å— / é«˜é›„',
                baseFare: 85,
                baseDistance: 1250,
                distStep: 200,
                distPrice: 5,
                idleSpeedThreshold: 5,
                idleStep: 100,
                idlePrice: 5,
                nightSurchargeType: 'PERCENTAGE',
                nightSurchargeValue: 0.2 // 20%
            }
        };

        // --- 2. ç‹€æ…‹ç®¡ç† (State) ---
        const state = {
            status: 'IDLE', // IDLE, RUNNING, FINISHED
            cityId: 'NORTH_CENTRAL',
            isNightMode: false,
            isSimulating: false,
            
            // è¨ˆé‡
            distanceMeters: 0,
            elapsedSeconds: 0,
            idleSeconds: 0,
            currentSpeedKmh: 0,
            currentFare: 85,
            
            // åœ°åœ–èˆ‡å®šä½
            currentLocation: { lat: 25.0478, lng: 121.5170 }, // å°åŒ—è»Šç«™é è¨­
            routePath: [], // [lat, lng] arrays
            heading: Math.random() * 360 // æ¨¡æ“¬ç”¨æ–¹å‘
        };

        // ç³»çµ±è®Šæ•¸
        let timerInterval = null;
        let watchId = null;
        let lastCoords = null; // ç´€éŒ„ä¸Šä¸€æ¬¡çœŸå¯¦ GPS åº§æ¨™èˆ‡æ™‚é–“
        let map = null;
        let marker = null;
        let polyline = null;

        // --- 3. DOM å…ƒç´ å¿«å– ---
        const dom = {
            valFare: document.getElementById('val-fare'),
            valDist: document.getElementById('val-dist'),
            valSpeed: document.getElementById('val-speed'),
            valIdle: document.getElementById('val-idle'),
            valTime: document.getElementById('val-time'),
            
            btnMain: document.getElementById('btn-main'),
            btnReset: document.getElementById('btn-reset'),
            btnSim: document.getElementById('btn-sim'),
            btnNight: document.getElementById('btn-night'),
            selectCity: document.getElementById('select-city'),
            
            badgeSim: document.getElementById('badge-sim'),
            badgeGps: document.getElementById('badge-gps'),
            errorMsg: document.getElementById('error-msg'),
            errorText: document.getElementById('error-text'),

            infoCityName: document.getElementById('info-city-name'),
            infoBase: document.getElementById('info-base'),
            infoDist: document.getElementById('info-dist'),
            infoDistStep: document.getElementById('info-dist-step'),
            infoIdle: document.getElementById('info-idle'),
            infoIdleStep: document.getElementById('info-idle-step'),
            infoNightMsg: document.getElementById('info-night-msg'),
            infoNightVal: document.getElementById('info-night-val'),
        };

        // --- 4. æ ¸å¿ƒé‚è¼¯å‡½å¼ ---

        // è¨ˆç®—è»Šè³‡
        function calculateFare(distMeters, idleSecs, config, isNight) {
            let fare = config.baseFare;

            // è·é›¢è¨ˆè²»
            if (distMeters > config.baseDistance) {
                const chargableDist = distMeters - config.baseDistance;
                const jumps = Math.ceil(chargableDist / config.distStep);
                fare += jumps * config.distPrice;
            }

            // å»¶æ»¯è¨ˆè²»
            const idleJumps = Math.floor(idleSecs / config.idleStep);
            fare += idleJumps * config.idlePrice;

            // å¤œé–“åŠ æˆ
            if (isNight) {
                if (config.nightSurchargeType === 'FLAT') {
                    fare += config.nightSurchargeValue;
                } else if (config.nightSurchargeType === 'PERCENTAGE') {
                    fare = fare * (1 + config.nightSurchargeValue);
                }
            }

            return Math.round(fare);
        }

        // è¨ˆç®—å…©é»è·é›¢ (Haversine Formula)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // meters
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const deltaPhi = (lat2 - lat1) * Math.PI / 180;
            const deltaLambda = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // æ™‚é–“æ ¼å¼åŒ– MM:SS
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h > 0 ? h.toString().padStart(2, '0') + ':' : ''}${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // --- 5. æµç¨‹æ§åˆ¶ ---

        function init() {
            initMap();
            updateConfigUI();
            updateDashboardUI();

            // å˜—è©¦ç²å–ä¸€æ¬¡ä½ç½®ä»¥å®šä½åœ°åœ–
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        updateLocation(pos.coords.latitude, pos.coords.longitude);
                    },
                    (err) => console.log("Init loc error", err),
                    { enableHighAccuracy: true }
                );
            }
        }

        function startMeter() {
            state.status = 'RUNNING';
            state.routePath = []; // æ¸…ç©ºè·¯å¾‘
            if(state.currentLocation) {
                state.routePath.push([state.currentLocation.lat, state.currentLocation.lng]);
            }
            
            // æ›´æ–° UI æŒ‰éˆ•ç‹€æ…‹
            renderButtons();
            hideError();

            if (state.isSimulating) {
                // æ¨¡æ“¬æ¨¡å¼ï¼šç›´æ¥å•Ÿå‹•è¨ˆæ™‚å™¨
                startTimer();
            } else {
                // çœŸå¯¦ GPS æ¨¡å¼
                if (!navigator.geolocation) {
                    showError("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ GPS");
                    stopMeter();
                    return;
                }
                watchId = navigator.geolocation.watchPosition(
                    handleGeoSuccess,
                    handleGeoError,
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
                );
                startTimer(); // è¨ˆæ™‚å™¨ç”¨æ–¼è¨ˆç®—å»¶æ»¯æ™‚é–“èˆ‡æ¨¡æ“¬è¿´åœˆ
            }
        }

        function stopMeter() {
            state.status = 'FINISHED';
            state.currentSpeedKmh = 0;
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            renderButtons();
            updateDashboardUI();
        }

        function resetMeter() {
            stopMeter();
            state.status = 'IDLE';
            state.distanceMeters = 0;
            state.elapsedSeconds = 0;
            state.idleSeconds = 0;
            state.currentSpeedKmh = 0;
            state.routePath = [];
            lastCoords = null;

            // é‡æ–°è¨ˆç®—èµ·å§‹åƒ¹æ ¼
            const config = RATE_CONFIG[state.cityId];
            state.currentFare = calculateFare(0, 0, config, state.isNightMode);

            // æ¸…é™¤åœ°åœ–ç·šæ¢
            if(polyline) polyline.setLatLngs([]);
            
            renderButtons();
            updateDashboardUI();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (state.isSimulating) {
                    runSimulationTick();
                } else {
                    runRealGPSTick(); // åƒ…è™•ç†æ™‚é–“èˆ‡å»¶æ»¯ï¼Œè·é›¢ç”± watchPosition è™•ç†
                }
                updateDashboardUI();
            }, 1000);
        }

        // --- 6. æ¨¡æ“¬èˆ‡ GPS è™•ç† ---

        function runSimulationTick() {
            const config = RATE_CONFIG[state.cityId];

            // 1. éš¨æ©Ÿè®Šæ›´é€Ÿåº¦
            let delta = (Math.random() * 10) - 4; 
            state.currentSpeedKmh += delta;
            if (state.currentSpeedKmh < 0) state.currentSpeedKmh = 0;
            if (state.currentSpeedKmh > 90) state.currentSpeedKmh = 90;
            if (Math.random() < 0.05) state.currentSpeedKmh = 0; // å¶çˆ¾ç´…ç‡ˆåœè»Š

            // 2. è¨ˆç®—é€™ä¸€ç§’çš„ç§»å‹•è·é›¢ (m)
            // è·é›¢ = é€Ÿåº¦(km/h) * 1000 / 3600
            const distStep = (state.currentSpeedKmh * 1000) / 3600;

            // 3. è¨ˆç®—æ–°åº§æ¨™
            if (distStep > 0) {
                state.heading += (Math.random() * 20) - 10; // ç¨å¾®è½‰å‘
                const rad = state.heading * (Math.PI / 180);
                const lat = state.currentLocation.lat;
                
                // ç°¡æ˜“ç¶“ç·¯åº¦æ¨ç®— (æ¯åº¦ç´„ 111km)
                const dLat = (distStep * Math.cos(rad)) / 111000;
                const dLng = (distStep * Math.sin(rad)) / (111000 * Math.cos(lat * (Math.PI / 180)));
                
                updateLocation(state.currentLocation.lat + dLat, state.currentLocation.lng + dLng);
                state.distanceMeters += distStep;
            }

            // 4. æ›´æ–°æ™‚é–“èˆ‡å»¶æ»¯
            state.elapsedSeconds++;
            const isIdle = state.currentSpeedKmh < config.idleSpeedThreshold;
            if (isIdle) state.idleSeconds++;

            // 5. è¨ˆç®—è»Šè³‡
            state.currentFare = calculateFare(state.distanceMeters, state.idleSeconds, config, state.isNightMode);
        }

        function handleGeoSuccess(position) {
            const { latitude, longitude, speed, accuracy } = position.coords;
            const now = Date.now();

            if (accuracy > 100) return; // å¿½ç•¥ç²¾æº–åº¦å¤ªå·®çš„è¨Šè™Ÿ

            updateLocation(latitude, longitude);

            // å¦‚æœä¸æ˜¯åŸ·è¡Œä¸­ï¼Œåªæ›´æ–°ä½ç½®å°±å¥½
            if (state.status !== 'RUNNING') return;

            let distDelta = 0;
            let currentSpeed = speed ? speed * 3.6 : 0; // m/s to km/h

            if (lastCoords) {
                const calculatedDist = getDistance(
                    lastCoords.latitude, lastCoords.longitude,
                    latitude, longitude
                );

                // GPS é£„ç§»éæ¿¾ï¼šåªæœ‰ç§»å‹•è¶…é 5 å…¬å°ºæ‰ç®—
                if (calculatedDist > 5) {
                    distDelta = calculatedDist;
                    state.distanceMeters += distDelta;
                }

                // å¦‚æœè£ç½®æ²’çµ¦é€Ÿåº¦ï¼Œè‡ªå·±ç®—
                if (speed === null && distDelta > 0) {
                    const timeDelta = (now - lastCoords.timestamp) / 1000;
                    if (timeDelta > 0) {
                        currentSpeed = (distDelta / timeDelta) * 3.6;
                    }
                }
            }

            // æ›´æ–°ç‹€æ…‹
            state.currentSpeedKmh = currentSpeed;
            lastCoords = { latitude, longitude, timestamp: now };
            
            // é‡æ–°è¨ˆç®—è»Šè³‡ (å› ç‚ºè·é›¢è®Šäº†)
            const config = RATE_CONFIG[state.cityId];
            state.currentFare = calculateFare(state.distanceMeters, state.idleSeconds, config, state.isNightMode);
            
            updateDashboardUI();
        }

        function handleGeoError(err) {
            showError(`GPS Error: ${err.message}`);
        }

        function runRealGPSTick() {
            // æ¯ç§’åŸ·è¡Œä¸€æ¬¡ï¼Œè™•ç†æ™‚é–“èˆ‡å»¶æ»¯
            // æ³¨æ„ï¼šè·é›¢æ˜¯åœ¨ handleGeoSuccess æ›´æ–°
            state.elapsedSeconds++;
            
            const config = RATE_CONFIG[state.cityId];
            const isIdle = state.currentSpeedKmh < config.idleSpeedThreshold;
            if (isIdle) state.idleSeconds++;

            state.currentFare = calculateFare(state.distanceMeters, state.idleSeconds, config, state.isNightMode);
        }


        // --- 7. UI æ›´æ–°èˆ‡åœ°åœ– ---

        function initMap() {
            // åˆå§‹åœ°åœ–ï¼šå°åŒ—
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([25.0478, 121.5170], 16);

            // ä½¿ç”¨ CartoDB Positron äº®è‰²åº•åœ–
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 20,
                subdomains: 'abcd'
            }).addTo(map);

            // è‡ªè¨‚è¨ˆç¨‹è»Š Icon (Emoji)
            const taxiIcon = L.divIcon({
                className: 'custom-taxi-icon',
                html: '<div style="font-size: 28px; line-height: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">ğŸš–</div>',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            marker = L.marker([25.0478, 121.5170], { icon: taxiIcon }).addTo(map);

            polyline = L.polyline([], {
                color: '#3b82f6', // blue-500
                weight: 5,
                opacity: 0.8,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);
            
            // åŠ å…¥ç‰ˆæ¬Šè³‡è¨Š
            L.control.attribution({ prefix: false }).addAttribution('Â© OSM, Â© CartoDB').addTo(map);
        }

        function updateLocation(lat, lng) {
            state.currentLocation = { lat, lng };
            if (marker) marker.setLatLng([lat, lng]);
            if (map) map.panTo([lat, lng], { animate: true, duration: 1 });
            
            // ç¹ªè£½è»Œè·¡
            if (state.status === 'RUNNING' || state.status === 'FINISHED') {
                if(state.routePath.length === 0 || 
                   state.routePath[state.routePath.length-1][0] !== lat) {
                    state.routePath.push([lat, lng]);
                    if (polyline) polyline.setLatLngs(state.routePath);
                }
            }
        }

        function updateDashboardUI() {
            // æ•¸å€¼é¡¯ç¤º
            dom.valFare.innerText = Math.round(state.currentFare);
            dom.valDist.innerText = (state.distanceMeters / 1000).toFixed(2);
            dom.valSpeed.innerText = state.currentSpeedKmh.toFixed(1);
            dom.valIdle.innerText = formatTime(state.idleSeconds);
            dom.valTime.innerText = formatTime(state.elapsedSeconds);

            // é€Ÿåº¦é¡è‰²è­¦å‘Š
            if (state.currentSpeedKmh > 80) {
                dom.valSpeed.classList.remove('text-emerald-700');
                dom.valSpeed.classList.add('text-red-600');
            } else {
                dom.valSpeed.classList.remove('text-red-600');
                dom.valSpeed.classList.add('text-emerald-700');
            }
        }

        function updateConfigUI() {
            const config = RATE_CONFIG[state.cityId];
            
            dom.infoCityName.innerText = config.name + " è¨ˆè²»è¦å‰‡";
            dom.infoBase.innerText = `$${config.baseFare}`;
            dom.infoDist.innerText = `$${config.distPrice}`;
            dom.infoDistStep.innerText = config.distStep;
            dom.infoIdle.innerText = `$${config.idlePrice}`;
            dom.infoIdleStep.innerText = config.idleStep;

            if (state.isNightMode) {
                dom.infoNightMsg.classList.remove('hidden-el');
                const val = config.nightSurchargeType === 'PERCENTAGE' 
                    ? `+${config.nightSurchargeValue * 100}%` 
                    : `+$${config.nightSurchargeValue}`;
                dom.infoNightVal.innerText = val;
                
                dom.btnNight.classList.add('bg-indigo-600', 'border-indigo-600', 'text-white');
                dom.btnNight.classList.remove('bg-white', 'text-gray-600');
            } else {
                dom.infoNightMsg.classList.add('hidden-el');
                
                dom.btnNight.classList.remove('bg-indigo-600', 'border-indigo-600', 'text-white');
                dom.btnNight.classList.add('bg-white', 'text-gray-600');
            }
        }

        function renderButtons() {
            const isIdle = state.status === 'IDLE';
            const isRunning = state.status === 'RUNNING';
            const isFinished = state.status === 'FINISHED';

            // æ¨¡æ“¬æŒ‰éˆ•ï¼šåªæœ‰ IDLE ç‹€æ…‹å¯ä»¥åˆ‡æ›
            if (isIdle) {
                dom.btnSim.disabled = false;
                dom.btnSim.classList.remove('opacity-50', 'cursor-not-allowed');
                if (state.isSimulating) {
                    dom.btnSim.classList.add('bg-purple-50', 'border-purple-200', 'text-purple-600');
                    dom.btnSim.classList.remove('bg-white', 'text-gray-500');
                    dom.badgeSim.classList.remove('hidden-el');
                    dom.badgeGps.classList.add('hidden-el');
                } else {
                    dom.btnSim.classList.remove('bg-purple-50', 'border-purple-200', 'text-purple-600');
                    dom.btnSim.classList.add('bg-white', 'text-gray-500');
                    dom.badgeSim.classList.add('hidden-el');
                    dom.badgeGps.classList.remove('hidden-el');
                }
            } else {
                // åŸ·è¡Œä¸­ä¸èƒ½åˆ‡æ›æ¨¡å¼
                dom.btnSim.disabled = true;
                dom.btnSim.classList.add('opacity-50', 'cursor-not-allowed');
            }

            // ä¸»æŒ‰éˆ• (é–‹å§‹/åœæ­¢)
            if (isRunning) {
                dom.btnMain.innerHTML = '<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12"/></svg> åœæ­¢è¨ˆè²»';
                dom.btnMain.classList.remove('bg-emerald-500', 'hover:bg-emerald-600', 'shadow-emerald-200');
                dom.btnMain.classList.add('bg-red-500', 'hover:bg-red-600', 'shadow-red-200');
            } else {
                dom.btnMain.innerHTML = '<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> é–‹å§‹è¨ˆè²»';
                dom.btnMain.classList.remove('bg-red-500', 'hover:bg-red-600', 'shadow-red-200');
                dom.btnMain.classList.add('bg-emerald-500', 'hover:bg-emerald-600', 'shadow-emerald-200');
            }

            // é‡ç½®æŒ‰éˆ•
            if (isRunning) {
                dom.btnReset.disabled = true;
                dom.btnReset.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-50');
            } else {
                dom.btnReset.disabled = false;
                dom.btnReset.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-50');
            }
            
            // è¨­å®šé–å®š
            dom.selectCity.disabled = isRunning;
            dom.btnNight.disabled = isRunning;
        }

        function showError(msg) {
            dom.errorText.innerText = msg;
            dom.errorMsg.classList.remove('hidden-el');
            setTimeout(() => {
                hideError();
            }, 5000);
        }

        function hideError() {
            dom.errorMsg.classList.add('hidden-el');
        }

        // --- 8. äº‹ä»¶ç›£è½ ---

        dom.btnMain.addEventListener('click', () => {
            if (state.status === 'RUNNING') {
                stopMeter();
            } else {
                startMeter();
            }
        });

        dom.btnReset.addEventListener('click', resetMeter);

        dom.btnSim.addEventListener('click', () => {
            if (state.status !== 'IDLE') return;
            state.isSimulating = !state.isSimulating;
            renderButtons();
        });

        dom.btnNight.addEventListener('click', () => {
            if (state.status === 'RUNNING') return;
            state.isNightMode = !state.isNightMode;
            // ç«‹å³é‡æ–°è¨ˆç®—åº•åƒ¹
            const config = RATE_CONFIG[state.cityId];
            state.currentFare = calculateFare(0, 0, config, state.isNightMode);
            updateConfigUI();
            updateDashboardUI();
        });

        dom.selectCity.addEventListener('change', (e) => {
            if (state.status === 'RUNNING') return;
            state.cityId = e.target.value;
            // é‡ç½®åƒ¹æ ¼
            resetMeter(); 
            updateConfigUI();
        });

        // å•Ÿå‹•æ‡‰ç”¨
        init();

    </script>
</body>
</html>
